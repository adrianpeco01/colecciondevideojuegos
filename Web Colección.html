<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Colección de Juegos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card-img {
      width: 130px;
      height: auto;
      border-radius: 0.5rem;
      cursor: pointer;
    }
    .login-error input,
    .login-error button {
      border-color: red !important;
      background-color: #fee2e2 !important; /* rojo claro */
      color: red !important;
    }

#loginTooltip {
  position: absolute;
  top: 100%;
  right: 48%;           /* Tooltip a la izquierda del botón */
  margin-top: 0.5rem;
  margin-right: 0px;    /* espacio entre tooltip y lápiz */
  padding: 0rem;
  width: 260px;
  z-index: 20;
}

#loginTooltip > div {
  position: relative;
  white-space: normal;
  margin: 0;               /* elimina márgenes */
  padding: 0.5rem 1rem 0.2rem 1rem; /* arriba, derecha, abajo, izquierda */
}

#loginTooltip .arrow {
  position: absolute;
  top: -6px;
  right: 10px;           /* Flecha al borde derecho del tooltip */
  width: 12px;
  height: 12px;
  background: #fecaca;
  border-top: 1px solid #fca5a5;
  border-right: 1px solid #fca5a5;
  transform: rotate(-45deg);  /* Flecha apuntando a la derecha */
  box-shadow: 1px -1px 0 #fca5a5;
}

/* Clase para desplazar el tooltip hacia la izquierda */
.tooltip-shift-left {
  left: auto !important;     /* Quitamos el left fijo */
  right: 12px !important;    /* Lo pegamos a la derecha con un margen */
}

.text-button {
  background: none;
  border: none;
  color: gray;
  cursor: pointer;
  font-size: 1rem;
  padding: 0;
  margin-top: 0.5rem;
  text-align: left;
}

.text-button:hover {
  color: darkgray;
}

#modal {
  display: none; /* oculto por defecto */
  position: fixed;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
  z-index: 50;
  opacity: 0;
  pointer-events: none;
  transition: opacity 200ms ease;
}

#modal.show {
  display: flex;
  opacity: 1;
  pointer-events: auto;
}

#modal > div {
  background: white;
  border-radius: 1rem;
  max-width: 400px;
  width: 90%;
  padding: 1.5rem;
  position: relative;
  transform: scale(0.7);
  opacity: 0;
    transition: transform 200ms ease, opacity 200ms ease;
  will-change: transform, opacity;
}

#modal.show > div {
  transform: scale(1);
  opacity: 1;
}

.zoom-image {
  position: fixed;
  z-index: 9999;
  border-radius: 0.5rem;
  transition: transform 0.5s ease, top 0.5s ease, left 0.5s ease, width 0.5s ease, height 0.5s ease;
  will-change: transform, top, left, width, height;
  cursor: default;
  object-fit: cover;
}
#modal.show {
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  background-color: rgba(0, 0, 0, 0.6); /* Fondo negro semi-transparente */
}
/* Placeholder para option disabled */
  select option[disabled] {
    color: #999999;
  }

  /* Flex para filas Consola y Carpeta */
  .select-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .select-row select {
    flex: 1;
  }
  .delete-option-btn {
    cursor: pointer;
    color: #999999;
    font-size: 1.25rem;
    user-select: none;
  }
  .delete-option-btn:hover {
    color: #e74c3c;
  }
  /* Para alinear icono y input de fecha */
  .date-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .date-row span {
    font-size: 1.5rem; /* icono calendario */
  }
  .date-row input[type="date"] {
    flex: 1;
  }
  select option[disabled] {
  color: #a0a0a0; /* gris claro similar a placeholder */
}
select:invalid {
  color: #a0a0a0;
}
select option:not([disabled]) {
  color: black; /* opciones normales en negro */
}
  select:invalid {
    color: #9ca3af; /* Tailwind gray-400 */
  }

  /* Cuando el usuario selecciona una opción válida, se cambia a negro */
  select option {
    color: #000;
  }

  /* Solo el placeholder (primera opción deshabilitada) tiene el gris claro */
  select option[disabled] {
    color: #9ca3af !important;
  }
  /* Fade in para el modal */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

#editModal {
  display: flex; /* para que quede centrado */
  justify-content: center;
  align-items: center;
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(6px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 60;
}

#editModal.active {
  opacity: 1;
  pointer-events: auto;
}

  </style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCb5vmEqe_IIasGYvH7e1g1ja56RwSoTSI",
    authDomain: "videojuegos-cfdee.firebaseapp.com",
    projectId: "videojuegos-cfdee",
    storageBucket: "videojuegos-cfdee.appspot.com",
    messagingSenderId: "698881133495",
    appId: "1:698881133495:web:21d918d5c0acddc5f63632"
  };

  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let games = [];
  let platforms = ["Playstation 4"];
  let folders = ["Colección"];

  async function loadData() {
    const gameSnap = await db.collection('games').get();
    games = gameSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    const platSnap = await db.collection('platforms').get();
    if (!platSnap.empty) platforms = platSnap.docs.map(doc => doc.data().name);

    const folderSnap = await db.collection('folders').get();
    if (!folderSnap.empty) folders = folderSnap.docs.map(doc => doc.data().name);

    renderGames();
  }

  loadData();
  
</script>

</head>
<body class="bg-green-50 p-4">
<div class="max-w-5xl mx-auto">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Artículos</h1>
    <div class="flex gap-2">
      <button id="viewList" class="text-lg px-2 py-1 rounded bg-blue-100 hover:bg-blue-200">📄 Lista</button>
      <button id="viewGrid" class="text-lg px-2 py-1 rounded bg-blue-100 hover:bg-blue-200">🔲 Cuadrícula</button>
    </div>

<div class="flex items-center gap-2 relative">
  <button id="toggleForm" class="text-blue-600 text-xl" title="Añadir o editar">✏️</button>

<!-- Bocadillo del lápiz -->
<div id="loginTooltip" class="absolute hidden z-30">
  <div class="relative bg-red-100 border border-red-300 text-red-900 rounded-xl shadow px-4 py-3 text-sm">
    <!-- Flecha -->
    <div class="arrow"></div>
    <p class="mb-2">Inicia sesión para poder añadir o editar juegos.</p>
  </div>
</div>

  <button id="authStatus" class="text-xl" title="Estado autenticación">🔒</button>
</div>
</div>


    <!-- Formulario (Oculto al iniciar) -->
<form id="gameForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-4 rounded-xl shadow mb-8 hidden">

  <!-- URL de imagen -->
  <div class="flex items-center gap-2">
    <span>🖼️</span>
    <input type="url" id="imageUrl" placeholder="URL de imagen*" class="border p-2 rounded w-full" required />
  </div>

  <!-- Título -->
  <div class="flex items-center gap-2">
    <span>🔠</span>
    <input type="text" id="title" placeholder="Título*" class="border p-2 rounded w-full" required />
  </div>

<!-- Plataforma -->
<div class="flex items-center gap-2">
  <span>🎮</span>
  <select id="platform" class="border p-2 rounded w-full text-gray-900" required>
    <option value="" disabled selected>Plataforma*</option>
    <!-- opciones dinámicas -->
  </select>
  <span class="delete-option-btn" title="Eliminar opción" onclick="removeSelectedOption('platform')">🗑️</span>
  <button type="button" id="addPlatform" class="text-sm text-blue-500 underline">Crear</button>
</div>

<!-- Carpeta -->
<div class="flex items-center gap-2">
  <span>📂</span>
  <select id="folder" class="border p-2 rounded w-full text-gray-900" required>
    <option value="" disabled selected>Carpeta*</option>
    <!-- opciones dinámicas -->
  </select>
  <span class="delete-option-btn" title="Eliminar opción" onclick="removeSelectedOption('folder')">🗑️</span>
  <button type="button" id="addFolder" class="text-sm text-blue-500 underline">Crear</button>
</div>
  <!-- Condición -->
  <div class="flex items-center gap-2 col-span-full md:col-span-1">
    <span>📦</span>
    <select id="condition" class="border p-2 rounded w-full" required>
      <option value="" disabled selected>Condición*</option>
      <option value="CIB">CIB</option>
      <option value="Solo Item">Solo Item</option>
      <option value="Caja y Manual">Caja y Manual</option>
      <option value="Manual">Manual</option>
      <option value="Carátula">Carátula</option>
    </select>
  </div>

  <!-- Estado (5 estrellas) -->
<div class="flex items-center gap-2 border p-2 rounded w-full cursor-pointer select-none" id="estadoStarsContainer" title="Estado*">
  <span>⭐</span>
  <div id="estadoStars" class="flex gap-1 text-yellow-400 text-3xl">
    <span data-star="1">☆</span>
    <span data-star="2">☆</span>
    <span data-star="3">☆</span>
    <span data-star="4">☆</span>
    <span data-star="5">☆</span>
  </div>
</div>

 <!-- Fecha de compra -->
<div class="flex items-center gap-2 w-full">
  <span class="text-xs">🗓️</span>
  <div class="relative w-full">
    <input 
      type="text" 
      id="purchaseDate" 
      onfocus="this.type='date'" 
      onblur="if(this.value===''){this.type='text'}" 
      placeholder="Fecha de compra*" 
      class="border p-2 rounded w-full text-gray-900 placeholder-gray-400"
      required 
    />
  </div>
</div>


<!-- Fecha de lanzamiento -->
<div class="flex items-center gap-2 w-full">
  <span class="text-xs">🕑</span>
  <div class="relative w-full">
    <input 
      type="text" 
      id="releaseDate" 
      onfocus="this.type='date'" 
      onblur="if(this.value===''){this.type='text'}" 
      placeholder="Fecha de lanzamiento" 
      class="border p-2 rounded w-full text-gray-900 placeholder-gray-400"
    />
  </div>
</div>

  <!-- Costo -->
  <div class="flex items-center gap-2">
    <span>💸</span>
    <input type="number" id="cost" placeholder="Coste (€)*" step="0.01" class="border p-2 rounded w-full" required />
  </div>

  <!-- Valor -->
  <div class="flex items-center gap-2">
    <span>💰</span>
    <input type="number" id="value" placeholder="Valor (€)" step="0.01" class="border p-2 rounded w-full" />
  </div>

  <!-- Enlaces de marketplaces -->
  <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="flex items-center gap-2">
      <img src="https://i.ibb.co/RpbCN10H/217439.png" alt="Wallapop" class="w-6 h-6" />
      <input type="url" id="wallapopLink" placeholder="Enlace Wallapop" class="border p-2 rounded w-full" />
    </div>
    <div class="flex items-center gap-2">
      <img src="https://i.ibb.co/gY2Tqd5/217438.png" alt="Vinted" class="w-6 h-6" />
      <input type="url" id="vintedLink" placeholder="Enlace Vinted" class="border p-2 rounded w-full" />
    </div>
    <div class="flex items-center gap-2">
      <img src="https://i.ibb.co/67Mcg0Qd/217436.png" alt="Ebay" class="w-6 h-6" />
      <input type="url" id="ebayLink" placeholder="Enlace eBay" class="border p-2 rounded w-full" />
    </div>
  </div>

  <!-- Cex y enlace Cex -->
  <div class="flex gap-2 md:col-span-2">
    <div class="flex items-center gap-2 flex-1">
      <span>🤑</span>
      <input type="number" id="cex" placeholder="Cex (€)" step="0.01" class="border p-2 rounded w-full" />
    </div>
    <div class="flex items-center gap-2 flex-1">
      <img src="https://i.ibb.co/kg4KSbJX/217437.png" alt="Cex" class="w-6 h-6" />
      <input type="url" id="cexLink" placeholder="Enlace Cex" class="border p-2 rounded w-full" />
    </div>
  </div>

  <!-- Otros datos -->
  <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="flex items-center gap-2">
    <span>📍</span>
    <input type="text" id="purchaseLocation" placeholder="Lugar de compra" class="border p-2 rounded w-full" />
  </div>
    <div class="flex items-center gap-2">
    <span>🌍</span>
    <input type="text" id="region" placeholder="Región" class="border p-2 rounded w-full" />
  </div>
  <div class="flex items-center gap-2">
    <span>🎁</span>
    <input type="text" id="gift" placeholder="Regalo" class="border p-2 rounded w-full" />
  </div>
  </div>

  <div class="flex items-center gap-2 md:col-span-2">
    <span>📄</span>
    <textarea id="details" placeholder="Detalles" class="border p-2 rounded w-full"></textarea>
  </div>

  <!-- Botón Guardar -->
  <button type="submit" class="col-span-full bg-blue-600 text-white py-2 rounded">Guardar</button>
</form>



    <!-- Lista de juegos -->
    <div id="gameList" class="space-y-4"></div>
  </div>

<!-- Modal de detalles -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center z-50">
<div class="bg-white p-8 rounded-2xl w-full max-w-[800px] min-w-[400px] relative">


    <!-- Botón cerrar -->
    <button onclick="closeModal()" class="absolute top-2 right-3 text-lg font-bold text-red-500">✕</button>

    <!-- Imagen del juego -->
    <img id="modalImage" src="" class="w-full max-h-[400px] object-contain rounded mb-4" />

    <!-- Detalles del juego -->
    <div id="modalDetails" class="text-gray-700"></div>

    <!-- Botones editar y borrar -->
    <div id="modalButtons" class="flex justify-end gap-4 mt-6 hidden">
      <button id="editBtn" title="Editar juego" class="text-blue-600 text-xl">✏️</button>
      <button id="deleteBtn" title="Borrar juego" class="text-red-600 text-xl">🗑️</button>
    </div>

  </div>
</div>

<!-- Modal de edición -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm opacity-0 pointer-events-none z-60 flex justify-center items-center">
  <div class="bg-white p-6 rounded-2xl w-full max-w-[600px] shadow-2xl relative">
    
    <!-- Cerrar con X -->
    <button id="closeEditFormBtn" onclick="closeEditModal()" class="absolute top-2 right-3 text-lg font-bold text-red-500">✕</button>

    <h2 class="text-xl font-bold mb-4">Editar juego</h2>
    
    <!-- Formulario Edición -->
<form id="editForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-4 rounded-xl shadow mb-8">

  <!-- URL de imagen -->
  <div class="flex items-center gap-2">
    <span>🖼️</span>
    <input type="url" id="imageUrl" placeholder="URL de imagen*" class="border p-2 rounded w-full" required />
  </div>

  <!-- Título -->
  <div class="flex items-center gap-2">
    <span>🔠</span>
    <input type="text" id="title" placeholder="Título*" class="border p-2 rounded w-full" required />
  </div>

<!-- Plataforma -->
<div class="flex items-center gap-2">
  <span>🎮</span>
  <select id="platform" class="border p-2 rounded w-full text-gray-900" required>
    <option value="" disabled selected>Plataforma*</option>
    <!-- opciones dinámicas -->
  </select>
  <span class="delete-option-btn" title="Eliminar opción" onclick="removeSelectedOption('platform')">🗑️</span>
  <button type="button" id="addPlatform" class="text-sm text-blue-500 underline">Crear</button>
</div>

<!-- Carpeta -->
<div class="flex items-center gap-2">
  <span>📂</span>
  <select id="folder" class="border p-2 rounded w-full text-gray-900" required>
    <option value="" disabled selected>Carpeta*</option>
    <!-- opciones dinámicas -->
  </select>
  <span class="delete-option-btn" title="Eliminar opción" onclick="removeSelectedOption('folder')">🗑️</span>
  <button type="button" id="addFolder" class="text-sm text-blue-500 underline">Crear</button>
</div>
  <!-- Condición -->
  <div class="flex items-center gap-2 col-span-full md:col-span-1">
    <span>📦</span>
    <select id="condition" class="border p-2 rounded w-full" required>
      <option value="" disabled selected>Condición*</option>
      <option value="CIB">CIB</option>
      <option value="Solo Item">Solo Item</option>
      <option value="Caja y Manual">Caja y Manual</option>
      <option value="Manual">Manual</option>
      <option value="Carátula">Carátula</option>
    </select>
  </div>

  <!-- Estado (5 estrellas) -->
<div class="flex items-center gap-2 border p-2 rounded w-full cursor-pointer select-none" id="estadoStarsContainer" title="Estado*">
  <span>⭐</span>
  <div id="estadoStars" class="flex gap-1 text-yellow-400 text-3xl">
    <span data-star="1">☆</span>
    <span data-star="2">☆</span>
    <span data-star="3">☆</span>
    <span data-star="4">☆</span>
    <span data-star="5">☆</span>
  </div>
</div>

 <!-- Fecha de compra -->
<div class="flex items-center gap-2 w-full">
  <span class="text-xs">🗓️</span>
  <div class="relative w-full">
    <input 
      type="text" 
      id="purchaseDate" 
      onfocus="this.type='date'" 
      onblur="if(this.value===''){this.type='text'}" 
      placeholder="Fecha de compra*" 
      class="border p-2 rounded w-full text-gray-900 placeholder-gray-400"
      required 
    />
  </div>
</div>


<!-- Fecha de lanzamiento -->
<div class="flex items-center gap-2 w-full">
  <span class="text-xs">🕑</span>
  <div class="relative w-full">
    <input 
      type="text" 
      id="releaseDate" 
      onfocus="this.type='date'" 
      onblur="if(this.value===''){this.type='text'}" 
      placeholder="Fecha de lanzamiento" 
      class="border p-2 rounded w-full text-gray-900 placeholder-gray-400"
    />
  </div>
</div>

  <!-- Costo -->
  <div class="flex items-center gap-2">
    <span>💸</span>
    <input type="number" id="cost" placeholder="Coste (€)*" step="0.01" class="border p-2 rounded w-full" required />
  </div>

  <!-- Valor -->
  <div class="flex items-center gap-2">
    <span>💰</span>
    <input type="number" id="value" placeholder="Valor (€)" step="0.01" class="border p-2 rounded w-full" />
  </div>

  <!-- Enlaces de marketplaces -->
  <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="flex items-center gap-2">
      <img src="https://i.ibb.co/RpbCN10H/217439.png" alt="Wallapop" class="w-6 h-6" />
      <input type="url" id="wallapopLink" placeholder="Enlace Wallapop" class="border p-2 rounded w-full" />
    </div>
    <div class="flex items-center gap-2">
      <img src="https://i.ibb.co/gY2Tqd5/217438.png" alt="Vinted" class="w-6 h-6" />
      <input type="url" id="vintedLink" placeholder="Enlace Vinted" class="border p-2 rounded w-full" />
    </div>
    <div class="flex items-center gap-2">
      <img src="https://i.ibb.co/67Mcg0Qd/217436.png" alt="Ebay" class="w-6 h-6" />
      <input type="url" id="ebayLink" placeholder="Enlace eBay" class="border p-2 rounded w-full" />
    </div>
  </div>

  <!-- Cex y enlace Cex -->
  <div class="flex gap-2 md:col-span-2">
    <div class="flex items-center gap-2 flex-1">
      <span>🤑</span>
      <input type="number" id="cex" placeholder="Cex (€)" step="0.01" class="border p-2 rounded w-full" />
    </div>
    <div class="flex items-center gap-2 flex-1">
      <img src="https://i.ibb.co/kg4KSbJX/217437.png" alt="Cex" class="w-6 h-6" />
      <input type="url" id="cexLink" placeholder="Enlace Cex" class="border p-2 rounded w-full" />
    </div>
  </div>

  <!-- Otros datos -->
  <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="flex items-center gap-2">
    <span>📍</span>
    <input type="text" id="purchaseLocation" placeholder="Lugar de compra" class="border p-2 rounded w-full" />
  </div>
    <div class="flex items-center gap-2">
    <span>🌍</span>
    <input type="text" id="region" placeholder="Región" class="border p-2 rounded w-full" />
  </div>
  <div class="flex items-center gap-2">
    <span>🎁</span>
    <input type="text" id="gift" placeholder="Regalo" class="border p-2 rounded w-full" />
  </div>
  </div>

  <div class="flex items-center gap-2 md:col-span-2">
    <span>📄</span>
    <textarea id="details" placeholder="Detalles" class="border p-2 rounded w-full"></textarea>
  </div>

  <!-- Botón Guardar -->
  <button type="submit" class="col-span-full bg-blue-600 text-white py-2 rounded">Guardar</button>
</form>

  </div>
</div>


  <script>
    const form = document.getElementById('gameForm');
    const toggleFormBtn = document.getElementById('toggleForm');
    const gameList = document.getElementById('gameList');
    const modal = document.getElementById('modal');
    const modalImage = document.getElementById('modalImage');
    const modalDetails = document.getElementById('modalDetails');
    const platformSelect = document.getElementById('platform');
    const folderSelect = document.getElementById('folder');
    const addPlatformBtn = document.getElementById('addPlatform');
    const addFolderBtn = document.getElementById('addFolder');


function populateSelect(select, items) {
  const placeholder = select.querySelector('option[disabled]');
  select.innerHTML = ''; // limpiamos todo

  if (placeholder) {
    select.appendChild(placeholder); // volvemos a agregar el placeholder
  }

  items.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    select.appendChild(option);
  });
}


addPlatformBtn.onclick = async () => {
  const newPlat = prompt('Nombre de nueva plataforma:');
  if (newPlat) {
    platforms.push(newPlat);
    await db.collection('platforms').add({ name: newPlat });
    populateSelect(platformSelect, platforms);
  }
};

addFolderBtn.onclick = async () => {
  const newFolder = prompt('Nombre de nueva carpeta:');
  if (newFolder) {
    folders.push(newFolder);
    await db.collection('folders').add({ name: newFolder });
    populateSelect(folderSelect, folders);
  }
};

 // Función para eliminar opción seleccionada de un select dado su id
  function removeSelectedOption(selectId) {
    const select = document.getElementById(selectId);
    const selectedValue = select.value;
    if (!selectedValue) return alert('Selecciona una opción para eliminar.');
    // Confirmar eliminación
    if (confirm(`¿Eliminar la opción "${selectedValue}"? Esta acción es irreversible.`)) {
      // Eliminar la opción
      const optionToRemove = Array.from(select.options).find(opt => opt.value === selectedValue);
      if (optionToRemove) {
        optionToRemove.remove();
        // Reiniciar selección
        select.value = '';
      }
    }
  }

  // Ajustar max fecha para España (sin restar horas)
  function getTodaySpain() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
  const todaySpain = getTodaySpain();
  document.getElementById('purchaseDate').max = todaySpain;
  document.getElementById('releaseDate').max = todaySpain;


 const estadoStars = document.getElementById('estadoStars');
  const stars = estadoStars.querySelectorAll('span');
  let estadoValue = 0; // valor guardado

  function pintarEstrellas(count) {
    stars.forEach(star => {
      const starVal = parseInt(star.dataset.star);
      if (starVal <= count) {
        star.textContent = '★'; // rellena
      } else {
        star.textContent = '☆'; // vacía
      }
    });
  }

  stars.forEach(star => {
    star.addEventListener('mouseenter', () => {
      const val = parseInt(star.dataset.star);
      pintarEstrellas(val);
    });
    star.addEventListener('mouseleave', () => {
      pintarEstrellas(estadoValue);
    });
    star.addEventListener('click', () => {
      estadoValue = parseInt(star.dataset.star);
      pintarEstrellas(estadoValue);
      console.log('Estado seleccionado:', estadoValue);
    });
  });

  pintarEstrellas(estadoValue);


function getFormData() {
  return {
    image: document.getElementById('imageUrl').value.trim(),
    title: document.getElementById('title').value.trim(),
    platform: platformSelect.value,
    folder: folderSelect.value,
    condition: document.getElementById('condition').value,
    estado: estadoValue,  // guardamos el estado de estrellas
    purchaseDate: document.getElementById('purchaseDate').value || null,
    releaseDate: document.getElementById('releaseDate').value || null,
    cost: parseFloat(document.getElementById('cost').value) || 0,
    value: parseFloat(document.getElementById('value').value) || 0,
    // quantity y estimated no están en tu formulario, si quieres añádelos con input y lee aquí
    wallapopLink: document.getElementById('wallapopLink').value.trim() || null,
    vintedLink: document.getElementById('vintedLink').value.trim() || null,
    ebayLink: document.getElementById('ebayLink').value.trim() || null,
    cex: parseFloat(document.getElementById('cex').value) || 0,
    cexLink: document.getElementById('cexLink').value.trim() || null,
    purchaseLocation: document.getElementById('purchaseLocation').value.trim() || null,
    region: document.getElementById('region').value.trim() || null,
    gift: document.getElementById('gift').value.trim() || null,
    details: document.getElementById('details').value.trim() || null,
  };
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  try {
    const gameData = getFormData();

    // Validaciones adicionales aquí si quieres
    if (!gameData.title || !gameData.platform || !gameData.folder || !gameData.condition || !gameData.cost) {
      alert('Por favor rellena todos los campos obligatorios');
      return;
    }

    const editingId = form.dataset.editing;

if (editingId) {
  // Modo edición: actualiza en Firebase y local
  await db.collection('games').doc(editingId).update(gameData);
  gameData.id = editingId;
  const index = parseInt(form.dataset.index);
  games[index] = gameData;
  alert('Juego actualizado correctamente');
} else {
  // Modo nuevo: crea
  const docRef = await db.collection('games').add(gameData);
  gameData.id = docRef.id;
  games.push(gameData);
  alert('Juego añadido correctamente');
}

    renderGames();
    form.reset();
    estadoValue = 0;
    pintarEstrellas(estadoValue);
    form.classList.add('hidden');
  } catch (error) {
    console.error('Error guardando el juego:', error);
    alert('Error al guardar el juego. Revisa la consola.');
  }
});

form.reset();
form.classList.add('hidden');
estadoValue = 0;
pintarEstrellas(estadoValue);
form.removeAttribute('data-editing');
form.removeAttribute('data-index');

    let currentView = 'list'; // 'grid' o 'list'

function renderGames() {
  populateSelect(platformSelect, platforms);
  populateSelect(folderSelect, folders);
  gameList.innerHTML = '';

  // Cambia clases del contenedor según vista
  if (currentView === 'grid') {
    gameList.className = "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4";
  } else {
    gameList.className = "space-y-4";
  }

  games.forEach((game, index) => {
    const card = document.createElement('div');

    if (currentView === 'list') {
      card.className = "flex bg-white rounded-xl shadow-md p-4 items-start";
      card.innerHTML = `
        <img src="${game.image || ''}" alt="Carátula" class="card-img mr-4" onclick="openModal(${index})"/>
        <div class="flex-1 flex flex-col justify-between">
          <div class="flex justify-between">
            <div>
              <h2 class="text-2xl font-bold mb-1">${game.title}</h2>
              <div class="text-base text-gray-700 mt-1">🎮 ${game.platform}</div>
              <div class="text-base text-gray-700">📁 ${game.folder}</div>
            </div>
            <div class="text-right text-sm font-semibold text-gray-700">
              VALOR<br><span class="text-lg font-bold text-black">€${(game.value ?? 0).toFixed(2)}</span><br>
              €${(game.estimated ?? 0).toFixed(2)}<br>
              <span class="text-xs mt-2 text-gray-600">COSTO</span><br>
              <span class="text-md font-bold">€${(game.cost ?? 0).toFixed(2)}</span>
            </div>
          </div>
          <div class="text-sm font-semibold mt-8">
            CONDICIÓN <span class="font-bold">${game.condition}</span> &nbsp; | &nbsp; Cant. ${game.quantity}
          </div>
        </div>
      `;
    } else {
      card.className = "bg-white rounded-xl shadow-md p-2 text-center cursor-pointer";
      card.innerHTML = `
        <img src="${game.image || ''}" alt="Carátula" class="w-full h-auto rounded mb-2" onclick="openModal(${index})"/>
        <div class="text-sm font-semibold text-gray-800">€${game.value.toFixed(2)}</div>
      `;
    }

    gameList.appendChild(card);
  });
}

document.getElementById('viewList').onclick = () => {
  currentView = 'list';
  renderGames();
};

document.getElementById('viewGrid').onclick = () => {
  currentView = 'grid';
  renderGames();
};

let originalGameData = null;

function openModal(index) {
  const game = games[index];
  const modalButtons = document.getElementById('modalButtons');
  const user = firebase.auth().currentUser;

  if (user) {
    modalButtons.classList.remove('hidden');
  } else {
    modalButtons.classList.add('hidden');
  }

document.getElementById("editBtn").onclick = () => openEditModal(game, index);

function openEditModal(game, index) {
  // Ocultar modal y mostrar formulario
  closeModal();
  form.classList.remove('hidden');

  // Rellenar campos
  document.getElementById('imageUrl').value = game.image || '';
  document.getElementById('title').value = game.title || '';
  platformSelect.value = game.platform || '';
  folderSelect.value = game.folder || '';
  document.getElementById('condition').value = game.condition || '';
  estadoValue = game.estado || 0;
  pintarEstrellas(estadoValue);
  document.getElementById('purchaseDate').value = game.purchaseDate || '';
  document.getElementById('releaseDate').value = game.releaseDate || '';
  document.getElementById('cost').value = game.cost ?? '';
  document.getElementById('value').value = game.value ?? '';
  document.getElementById('wallapopLink').value = game.wallapopLink || '';
  document.getElementById('vintedLink').value = game.vintedLink || '';
  document.getElementById('ebayLink').value = game.ebayLink || '';
  document.getElementById('cex').value = game.cex ?? '';
  document.getElementById('cexLink').value = game.cexLink || '';
  document.getElementById('purchaseLocation').value = game.purchaseLocation || '';
  document.getElementById('region').value = game.region || '';
  document.getElementById('gift').value = game.gift || '';
  document.getElementById('details').value = game.details || '';

  // Marcar como edición
  form.dataset.editing = game.id;
  form.dataset.index = index;
  
   // *** Aquí asignas la copia del estado original ***
  originalGameData = getFormData();
}


  modal.style.display = 'flex';
  setTimeout(() => modal.classList.add('show'), 10);

  modalImage.src = game.image;

  const formatMoney = (value) =>
    value && parseFloat(value) !== 0 ? `€${parseFloat(value).toFixed(2)}` : null;
  const formatText = (text) => (text ? text : null);

  // Condición y Estado juntos
const conditionAndState = (game.condition || game.estado)
  ? `<div class="mb-2 flex items-center gap-4">
       ${game.condition ? `<span title="Condición">📦 ${game.condition}</span>` : ''}
       ${game.estado ? `<span title="Estado">⭐ ${game.estado}</span>` : ''}
     </div>`
  : '';



  // Imagen ampliada con lupa
  const imageLink = game.image
    ? `<span class="cursor-pointer text-lg" title="Ampliar imagen" onclick="zoomImage('${game.image}')">🔍</span>`
    : '';

  const detailsTooltip = game.details
  ? `<span class="cursor-pointer text-lg" title="Detalles" onclick="showTooltip(event, \`${game.details.replace(/`/g, '\\`')}\`)">📄</span>`
  : '';

  const column1 = [
    game.platform && { icon: '🎮', label: game.platform, title: 'Plataforma' },
    game.region && { icon: '🌍', label: game.region, title: 'Región' },
    game.folder && { icon: '📂', label: game.folder, title: 'Carpeta' },
    'CONDICION_ESTADO_PLACEHOLDER',
    game.purchaseLocation && { icon: '📍', label: game.purchaseLocation, title: 'Lugar de compra' },
    game.gift && { icon: '🎁', label: game.gift, title: 'Regalo' },
  ];

  const column2 = [
    game.purchaseDate && { icon: '🗓️', label: game.purchaseDate, title: 'Fecha de compra' },
    game.releaseDate && { icon: '🕑', label: game.releaseDate, title: 'Fecha de lanzamiento' },
    formatMoney(game.value) && { icon: '💰', label: formatMoney(game.value), title: 'Valor (€)' },
    formatMoney(game.cost) && { icon: '💸', label: formatMoney(game.cost), title: 'Coste (€)' },
    (game.cexLink || formatMoney(game.cex)) && {
      icon: `<img src="https://i.ibb.co/kg4KSbJX/217437.png" alt="Cex" class="w-5 h-5 inline" />`,
      label: formatMoney(game.cex),
      title: 'Cex (€)',
      link: game.cexLink
    },
    game.wallapopLink && {
      icon: `<img src="https://i.ibb.co/RpbCN10H/217439.png" alt="Wallapop" class="w-5 h-5 inline" />`,
      label: 'Wallapop',
      link: game.wallapopLink
    },
    game.vintedLink && {
      icon: `<img src="https://i.ibb.co/gY2Tqd5/217438.png" alt="Vinted" class="w-5 h-5 inline" />`,
      label: 'Vinted',
      link: game.vintedLink
    },
    game.ebayLink && {
      icon: `<img src="https://i.ibb.co/67Mcg0Qd/217436.png" alt="eBay" class="w-5 h-5 inline" />`,
      label: 'eBay',
      link: game.ebayLink
    },
  ];

function closeEditModal() {
  const editModal = document.getElementById('editModal');
  editModal.classList.remove('active');
}

  const renderColumn = (items) =>
    items
      .filter(Boolean)
      .map((item) => {
        if (item === 'CONDICION_ESTADO_PLACEHOLDER') {
          return conditionAndState;
        }
        if (item.link) {
          return `
            <div class="mb-2 flex items-center gap-2">
              <a href="${item.link}" target="_blank" class="flex items-center gap-1">
                ${item.icon}
                <span class="underline">${item.label}</span>
              </a>
            </div>`;
        }
        return `
          <div class="mb-2 flex items-center gap-2">
            <span title="${item.title || ''}">${item.icon}</span>
            <span>${item.label}</span>
          </div>`;
      })
      .join('');

  modalDetails.innerHTML = `
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
    ${game.title} ${imageLink} ${detailsTooltip}
  </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-6xl">
      <div>${renderColumn(column1)}</div>
      <div>${renderColumn(column2)}</div>
    </div>
  `;
}

function showTooltip(event, text) {
  const tooltip = document.getElementById('tooltipDetails');
  tooltip.innerText = text;
  tooltip.style.left = `${event.pageX + 10}px`;
  tooltip.style.top = `${event.pageY + 10}px`;
  tooltip.classList.remove('hidden');
}

document.addEventListener('click', (e) => {
  const tooltip = document.getElementById('tooltipDetails');
  if (!tooltip.contains(e.target) && !e.target.closest('[onclick^="showTooltip"]')) {
    tooltip.classList.add('hidden');
  }
});

function closeModal() {
  // Quitar la clase que activa la opacidad
  modal.classList.remove('show');

  // Esperar a que termine la transición antes de ocultar completamente el modal
  setTimeout(() => {
    modal.style.display = 'none';
    modalImage.src = '';
    modalDetails.innerHTML = '';
  }, 200); // ajusta este valor para que coincida con la duración de tu transición en CSS
}

// Cerrar modal al hacer click fuera del contenido
modal.addEventListener('click', (e) => {
  if (e.target === modal) {
    closeModal();
  }
});


// Logout (opcional: puedes poner un botón)
function logout() {
  auth.signOut().then(() => {
    alert("Sesión cerrada");
    location.reload();
  });
}

window.addEventListener('beforeunload', () => {
  firebase.auth().signOut();
});

document.addEventListener('DOMContentLoaded', () => {
  const toggleFormBtn = document.getElementById('toggleForm');
  const authStatus = document.getElementById('authStatus');
  const form = document.getElementById('gameForm');
  const loginModal = document.getElementById('loginModal');
  const loginEmail = document.getElementById('loginEmail');
  const loginPassword = document.getElementById('loginPassword');
  const loginSubmit = document.getElementById('loginSubmit');

  
loginEmail.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();  // evita que el formulario se envíe automáticamente
    loginSubmit.click();
  }
});

loginPassword.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    loginSubmit.click();
  }
});


  let isAuthenticated = false;

  // Actualiza icono según estado
  function updateAuthIcon(user) {
    if (user) {
      isAuthenticated = true;
      authStatus.textContent = "🔓";
      authStatus.title = "Autenticado como " + user.email;
    } else {
      isAuthenticated = false;
      authStatus.textContent = "🔒";
      authStatus.title = "No autenticado";
      form.classList.add('hidden'); // Oculta formulario si no autenticado
    }
  }

  // Observa cambios en autenticación
  auth.onAuthStateChanged(user => {
    updateAuthIcon(user);
  });

  // Al pulsar el lápiz
  toggleFormBtn.onclick = () => {
    const user = auth.currentUser;
    const tooltip = document.getElementById('loginTooltip');

    if (user) {
      // Si está logueado, alterna el formulario como antes
      tooltip.classList.add('hidden');
      form.classList.toggle('hidden');
    } else {
      // Si el tooltip ya está visible, ocultarlo
      if (!tooltip.classList.contains('hidden')) {
        tooltip.classList.add('hidden');
        return;
      }

      // Mostrar tooltip y ajustar si se sale de la ventana
      tooltip.classList.remove('hidden');

      const tooltipRect = tooltip.getBoundingClientRect();
      const windowWidth = window.innerWidth;

      if (tooltipRect.right > windowWidth - 20) {
        tooltip.classList.add('tooltip-shift-left');
      } else {
        tooltip.classList.remove('tooltip-shift-left');
      }
    }
  };

  // Pulsar en icono 🔒 o 🔓 para cerrar sesión si está autenticado
authStatus.onclick = () => {
  if (isAuthenticated) {
    auth.signOut();
    alert('Sesión cerrada');
  } else {
    document.getElementById('loginModal').classList.remove('hidden');
  }
};


  // Botón login
  loginSubmit.onclick = () => {
    const email = loginEmail.value.trim();
    const password = loginPassword.value.trim();

    if (!email || !password) {
      alert('Introduce correo y contraseña');
      return;
    }

    auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        loginModal.classList.add('hidden');
        form.classList.remove('hidden');
        loginModal.classList.remove('login-error');
      })
      .catch(() => {
        // Poner modal en rojo si error
        loginModal.classList.add('login-error');
      });
  };

  // También cerrar modal login si se clica fuera (opcional)
  loginModal.onclick = (e) => {
    if (e.target === loginModal) {
      loginModal.classList.add('hidden');
      loginModal.classList.remove('login-error');
    }
  };
});

const authStatusBtn = document.getElementById('authStatus');

function updateAuthStatusIcon(user) {
  if (user) {
    authStatusBtn.textContent = '🔓'; // Desbloqueado
    authStatusBtn.title = `Autenticado como: ${user.email}`;
  } else {
    authStatusBtn.textContent = '🔒'; // Bloqueado
    authStatusBtn.title = 'No autenticado';
  }
}

// Observa cambios en la autenticación y actualiza el icono
auth.onAuthStateChanged(user => {
  updateAuthStatusIcon(user);
  if (!user) {
    form.classList.add('hidden'); // Oculta el formulario si no autenticado
  }
});

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('logoutButton').addEventListener('click', () => {
      document.getElementById('loginModal').classList.add('hidden');
    });
  });

  document.addEventListener('click', (event) => {
  const tooltip = document.getElementById('loginTooltip');
  const pencilBtn = document.getElementById('toggleForm'); // botón del lápiz
  // Si el tooltip está visible y el click no es ni dentro del tooltip ni sobre el lápiz, ocultamos el tooltip
  if (
    !tooltip.classList.contains('hidden') && 
    !tooltip.contains(event.target) && 
    event.target !== pencilBtn
  ) {
    tooltip.classList.add('hidden');
  }
});

function zoomImage(src) {
  const overlay = document.getElementById('zoomOverlay');
  const zoomedImg = document.getElementById('zoomedImage');
  zoomedImg.src = src;
  overlay.classList.remove('hidden');
}

document.getElementById('zoomOverlay').addEventListener('click', () => {
  document.getElementById('zoomOverlay').classList.add('hidden');
});

function openEditModal(game) {
  // Rellenar los campos del formulario con los datos del juego
  document.getElementById("imageUrl").value = game.imageUrl || '';
  document.getElementById("title").value = game.title || '';
  document.getElementById("platform").value = game.platform || '';
  document.getElementById("folder").value = game.folder || '';
  document.getElementById("condition").value = game.condition || '';
  document.getElementById("cost").value = game.cost || '';
  document.getElementById("value").value = game.value || '';
  document.getElementById("purchaseDate").value = game.purchaseDate || '';
  document.getElementById("releaseDate").value = game.releaseDate || '';
  document.getElementById("region").value = game.region || '';
  document.getElementById("purchaseLocation").value = game.purchaseLocation || '';
  document.getElementById("gift").value = game.gift || '';
  document.getElementById("details").value = game.details || '';
  document.getElementById("wallapopLink").value = game.wallapopLink || '';
  document.getElementById("vintedLink").value = game.vintedLink || '';
  document.getElementById("ebayLink").value = game.ebayLink || '';
  document.getElementById("cex").value = game.cex || '';
  document.getElementById("cexLink").value = game.cexLink || '';

  // Estado (estrellas)
  if (game.state) {
    const stars = document.querySelectorAll('#estadoStars span');
    stars.forEach((star, index) => {
      star.textContent = index < game.state ? '★' : '☆';
    });
  }

  // Mostrar modal
  const editModal = document.getElementById("editModal");
  editModal.classList.remove("hidden");

  // Guardar el ID del juego en el modal para luego usarlo
  editModal.dataset.gameId = game.id;

  // Asignar submit al formulario
  document.getElementById("editForm").onsubmit = function (e) {
    e.preventDefault();
    saveEditedGame(game.id);
  };
}

function openEditModal() {
  const editModal = document.getElementById('editModal');
  editModal.classList.add('show');
  // Quitar la clase hidden si está (por si acaso)
  editModal.classList.remove('hidden');
}

function closeEditModal() {
  const editModal = document.getElementById("editModal");
  editModal.classList.add("hidden");
}


async function saveEditedGame(gameId) {
  const docRef = db.collection("games").doc(gameId);

  const updatedGame = {
    title: document.getElementById("title").value,
    imageUrl: document.getElementById("imageUrl").value,
    platform: document.getElementById("platform").value,
    folder: document.getElementById("folder").value,
    condition: document.getElementById("condition").value,
    cost: parseFloat(document.getElementById("cost").value) || 0,
    value: parseFloat(document.getElementById("value").value) || 0,
    purchaseDate: document.getElementById("purchaseDate").value,
    releaseDate: document.getElementById("releaseDate").value,
    region: document.getElementById("region").value,
    purchaseLocation: document.getElementById("purchaseLocation").value,
    gift: document.getElementById("gift").value,
    details: document.getElementById("details").value,
    wallapopLink: document.getElementById("wallapopLink").value,
    vintedLink: document.getElementById("vintedLink").value,
    ebayLink: document.getElementById("ebayLink").value,
    cex: parseFloat(document.getElementById("cex").value) || 0,
    cexLink: document.getElementById("cexLink").value,
    state: getSelectedStars()
  };

  try {
    await docRef.update(updatedGame);
    closeEditModal();
    loadData(); // Recargar la lista desde Firebase
  } catch (error) {
    console.error("Error al guardar el juego:", error);
    alert("Hubo un error al guardar los cambios.");
  }
}

function getSelectedStars() {
  const stars = document.querySelectorAll('#estadoStars span');
  let selected = 0;
  stars.forEach((star, index) => {
    if (star.textContent === '★') selected = index + 1;
  });
  return selected;
}

document.getElementById('closeEditFormBtn').addEventListener('click', () => {
  const currentData = getFormData();

  // Comparar como JSON para simplicidad (puedes mejorar esto con comparación profunda si hace falta)
  if (JSON.stringify(currentData) !== JSON.stringify(originalGameData)) {
    const confirmExit = confirm("Tienes cambios sin guardar. ¿Seguro que quieres cerrar el formulario?");
    if (!confirmExit) return;
  }

  form.reset();
  estadoValue = 0;
  pintarEstrellas(estadoValue);
  form.classList.add('hidden');
  form.removeAttribute('data-editing');
  form.removeAttribute('data-index');
  originalGameData = null;
});

  </script>

  <!-- Modal login -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex justify-center items-center z-50">
  <div class="bg-white p-6 rounded-xl max-w-sm w-full relative shadow">
    <h2 class="text-xl font-bold mb-4">Iniciar sesión</h2>
    <input id="loginEmail" type="email" placeholder="Correo" class="w-full mb-2 border p-2 rounded" />
    <input id="loginPassword" type="password" placeholder="Contraseña" class="w-full mb-4 border p-2 rounded" />
    <button id="loginSubmit" class="w-full bg-blue-600 text-white py-2 rounded">Acceder</button>
    <button id="logoutButton" class="text-gray-500 hover:text-gray-700 text-sm px-2 py-1 mt-2 mx-auto block">Salir</button>

  </div>
</div>

<!-- Imagen ampliada -->
<div id="fullscreenImage" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm hidden justify-center items-center z-[60]">
  <img id="fullscreenImageTag" src="" class="max-w-full max-h-full rounded-lg shadow-xl">
</div>

<!-- Bocadillo de detalles -->
<div id="tooltipDetails" class="hidden absolute bg-white text-black text-sm p-4 rounded shadow-lg max-w-md z-[70]"></div>

<!-- Overlay para zoom de imagen -->
<div id="zoomOverlay" class="fixed inset-0 bg-black bg-opacity-80 hidden justify-center items-center z-50">
  <img id="zoomedImage" class="max-w-full max-h-full rounded shadow-lg" />
</div>


</body>
</html>
